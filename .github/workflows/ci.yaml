name: CI/CD

on:
  push:
    branches:
      - master
      - arm-au
  workflow_dispatch:

jobs:
  build:
    name: docker
    runs-on: ubuntu-latest
    steps:
      - name: checkout scm
        uses: actions/checkout@v2
      - name: docker/build-push
        uses: docker/build-push-action@v1
        if: ${{ github.ref == 'refs/heads/master' }}
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          repository: hacksore/hks
          tags: latest
      - name: docker/run
        if: ${{ github.ref == 'refs/heads/master' }}
        run: |
          docker run hacksore/hks:latest 'hyundai' 'list' '99cfff84-f4e2-4be8-a5ed-e5b755eb6581' > hyundai.list.txt
      - name: docker/run
        if: ${{ github.ref == 'refs/heads/master' }}
        run:
          docker run hacksore/hks:latest 'kia' 'list' '693a33fa-c117-43f2-ae3b-61a02d24f417' > kia.list.txt
      - uses: actions/upload-artifact@v2
        if: ${{ github.ref == 'refs/heads/master' }}
        with:
          name: hyundai.stamps
          path: hyundai.list.txt
      - uses: actions/upload-artifact@v2
        if: ${{ github.ref == 'refs/heads/master' }}
        with:
          name: kia.stamps
          path: kia.list.txt
      - name: Set up Docker Buildx for ARM build
        if: ${{ github.ref == 'refs/heads/arm-au' }}
        uses: crazy-max/ghaction-docker-buildx@v1
        with:
          version: latest
      - name: Docker Login  for ARM build
        if: ${{ github.ref == 'refs/heads/arm-au' }}
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login --username "${{ secrets.DOCKER_USERNAME }}" --password-stdin
      - name: Run Buildx and push image for ARM build
        if: ${{ github.ref == 'refs/heads/arm-au' }}
        run: |
          docker buildx build --platform=linux/arm64 -t hacksore/hks:arm-au . --load
          docker push hacksore/hks:arm-au
